
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="AWS">
      
      
        <link rel="canonical" href="https://aws-observability.github.io/aws-o11y-recipes/recipes/amg-athena-plugin/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.1">
    
    
      
        <title>Using Athena in Amazon Managed Grafana - AWS Observability Recipes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ffa724">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i%7CPT+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Lato";--md-code-font:"PT Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    

<script>
  (function(n,i,v,r,s,c,x,z){x=window.AwsRumClient={q:[],n:n,i:i,v:v,r:r,c:c};window[n]=function(c,p){x.q.push({c:c,p:p});};z=document.createElement('script');z.async=true;z.src=s;document.head.insertBefore(z,document.head.getElementsByTagName('script')[0]);})(
    'cwr',
    'eb23e08d-e6d5-491d-8533-7ed9d0bc67d6',
    '1.0.0',
    'us-east-1',
    'https://client.rum.us-east-1.amazonaws.com/1.12.0/cwr.js',
    {
      sessionSampleRate: 1,
      guestRoleArn: "arn:aws:iam::913180151358:role/RUM-Monitor-us-east-1-913180151358-9729762338561-Unauth",
      identityPoolId: "us-east-1:f1fb552f-ddbe-4476-883f-d53be9a9c14c",
      endpoint: "https://dataplane.rum.us-east-1.amazonaws.com",
      telemetries: ["performance","errors","http"],
      allowCookies: false,
      enableXRay: false
    }
  );
</script>


  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-athena-in-amazon-managed-grafana" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AWS Observability Recipes" class="md-header__button md-logo" aria-label="AWS Observability Recipes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M256 0v128h128L256 0zm32 256H96v64h192v-64zm-64-128V0H48C21.49 0 0 21.49 0 48v416c0 26.5 21.49 48 48 48h288c26.51 0 48-21.49 48-48V160H256.9c-18.6 0-32.9-14.3-32.9-32zM64 72c0-4.37 3.63-8 8-8h80c4.4 0 8 3.63 8 8v16c0 4.38-3.6 8-8 8H72c-4.37 0-8-3.62-8-8V72zm0 64c0-4.4 3.63-8 8-8h80c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H72c-4.37 0-8-3.6-8-8v-16zm256 304c0 4.375-3.625 8-8 8h-80c-4.4 0-8-3.6-8-8v-16c0-4.375 3.625-8 8-8h80c4.375 0 8 3.625 8 8v16zm0-200v96c0 8.875-7.125 16-16 16H80c-8.87 0-16-7.1-16-16v-96c0-8.9 7.13-16 16-16h224c8.9 0 16 7.1 16 16z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AWS Observability Recipes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Using Athena in Amazon Managed Grafana
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-observability/aws-o11y-recipes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-observability/aws-o11y-recipes
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../apprunner/" class="md-tabs__link">
        By Compute
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../infra/" class="md-tabs__link">
        By Infra & Databases
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../java/" class="md-tabs__link">
        By Language
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../cw/" class="md-tabs__link">
        By Destination
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../anomaly-detection/" class="md-tabs__link">
        Tasks
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../about/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AWS Observability Recipes" class="md-nav__button md-logo" aria-label="AWS Observability Recipes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M256 0v128h128L256 0zm32 256H96v64h192v-64zm-64-128V0H48C21.49 0 0 21.49 0 48v416c0 26.5 21.49 48 48 48h288c26.51 0 48-21.49 48-48V160H256.9c-18.6 0-32.9-14.3-32.9-32zM64 72c0-4.37 3.63-8 8-8h80c4.4 0 8 3.63 8 8v16c0 4.38-3.6 8-8 8H72c-4.37 0-8-3.62-8-8V72zm0 64c0-4.4 3.63-8 8-8h80c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H72c-4.37 0-8-3.6-8-8v-16zm256 304c0 4.375-3.625 8-8 8h-80c-4.4 0-8-3.6-8-8v-16c0-4.375 3.625-8 8-8h80c4.375 0 8 3.625 8 8v16zm0-200v96c0 8.875-7.125 16-16 16H80c-8.87 0-16-7.1-16-16v-96c0-8.9 7.13-16 16-16h224c8.9 0 16 7.1 16 16z"/></svg>

    </a>
    AWS Observability Recipes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-observability/aws-o11y-recipes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-observability/aws-o11y-recipes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dimensions/" class="md-nav__link">
        Dimensions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../telemetry/" class="md-nav__link">
        Telemetry
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          By Compute
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Compute" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          By Compute
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../apprunner/" class="md-nav__link">
        AWS App Runner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eks/" class="md-nav__link">
        Amazon Elastic Kubernetes Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ecs/" class="md-nav__link">
        Amazon Elastic Container Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lambda/" class="md-nav__link">
        AWS Lambda
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          By Infra & Databases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Infra & Databases" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          By Infra & Databases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/" class="md-nav__link">
        Infra
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Databases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Databases" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Databases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rds/" class="md-nav__link">
        Amazon Relational Database Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dynamodb/" class="md-nav__link">
        Amazon DynamoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../msk/" class="md-nav__link">
        Amazon Managed Streaming for Apache Kafka
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          By Language
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Language" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          By Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../java/" class="md-nav__link">
        Java
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodejs/" class="md-nav__link">
        Node.js
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          By Destination
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Destination" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          By Destination
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cw/" class="md-nav__link">
        Amazon CloudWatch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../amp/" class="md-nav__link">
        Amazon Managed Service for Prometheus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../amg/" class="md-nav__link">
        Amazon Managed Grafana
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aes/" class="md-nav__link">
        Amazon OpenSearch Service
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Tasks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tasks" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anomaly-detection/" class="md-nav__link">
        Anomaly Detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../alerting/" class="md-nav__link">
        Alerting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workshops/" class="md-nav__link">
        Workshops
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#infrastructure" class="md-nav__link">
    Infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-amazon-athena" class="md-nav__link">
    Set up Amazon Athena
  </a>
  
    <nav class="md-nav" aria-label="Set up Amazon Athena">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-geographical-data" class="md-nav__link">
    Load geographical data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-vpc-flow-logs-data" class="md-nav__link">
    Load VPC flow logs data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-grafana" class="md-nav__link">
    Set up Grafana
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-geographical-data" class="md-nav__link">
    Use geographical data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-vpc-flow-logs-data" class="md-nav__link">
    Use VPC flow logs data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/aws-observability/aws-o11y-recipes/edit/master/docs/recipes/amg-athena-plugin.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="using-athena-in-amazon-managed-grafana">Using Athena in Amazon Managed Grafana<a class="headerlink" href="#using-athena-in-amazon-managed-grafana" title="Permanent link">&para;</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This site is being merged into the broader <a href="https://aws-observability.github.io/observability-best-practices/recipes/">Observability Best Practices</a> content. Please head over there for the latest updates, plus prescriptive guidance on the use of AWS observability tools.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This site will be kept as-is until January 2023, when it will be decommissioned.</p>
</div>
<hr />
<p>In this recipe we show you how to use <a href="https://aws.amazon.com/athena/">Amazon Athena</a>—a serverless, 
interactive query service allowing you to analyze data in Amazon S3 using 
standard SQL—in <a href="https://aws.amazon.com/grafana/">Amazon Managed Grafana</a>. This integration
is enabled by the <a href="https://grafana.com/grafana/plugins/grafana-athena-datasource/">Athena data source for Grafana</a>, an open source
plugin available for you to use in any DIY Grafana instance as well as 
pre-installed in Amazon Managed Grafana.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide will take approximately 20 minutes to complete.</p>
</div>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>The <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">AWS CLI</a> is installed and <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">configured</a> in your environment.</li>
<li>You have access to Amazon Athena from your account.</li>
</ul>
<h2 id="infrastructure">Infrastructure<a class="headerlink" href="#infrastructure" title="Permanent link">&para;</a></h2>
<p>Let's first set up the necessary infrastructure.</p>
<h3 id="set-up-amazon-athena">Set up Amazon Athena<a class="headerlink" href="#set-up-amazon-athena" title="Permanent link">&para;</a></h3>
<p>We want to see how to use Athena in two different scenarios: one scenario around
geographical data along with the Geomap plugin, and one in a security-relevant
scenario around VPC flow logs.</p>
<p>First, let's make sure Athena is set up and the datasets are loaded.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You have to use the Amazon Athena console to execute these queries. Grafana
in general has read-only access to the data sources, so can not be used
to create or update data.</p>
</div>
<h4 id="load-geographical-data">Load geographical data<a class="headerlink" href="#load-geographical-data" title="Permanent link">&para;</a></h4>
<p>In this first use case we use a dataset from the <a href="https://registry.opendata.aws/">Registry of Open Data on AWS</a>.
More specifically, we will use <a href="https://aws.amazon.com/blogs/big-data/querying-openstreetmap-with-amazon-athena/">OpenStreetMap</a> (OSM) to demonstrate
the usage of the Athena plugin for a geographical data motivated use case.
For that to work, we need to first get the OSM data into Athena.</p>
<p>So, first off, create a new database in Athena. Go to the <a href="https://console.aws.amazon.com/athena/">Athena
console</a> and there use the following three 
SQL queries to import the OSM data into the database.</p>
<p>Query 1:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">EXTERNAL</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">planet</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">tags</span><span class="w"> </span><span class="k">MAP</span><span class="o">&lt;</span><span class="n">STRING</span><span class="p">,</span><span class="n">STRING</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">lat</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">lon</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">nds</span><span class="w"> </span><span class="nb">ARRAY</span><span class="o">&lt;</span><span class="n">STRUCT</span><span class="o">&lt;</span><span class="k">ref</span><span class="p">:</span><span class="w"> </span><span class="nb">BIGINT</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">members</span><span class="w"> </span><span class="nb">ARRAY</span><span class="o">&lt;</span><span class="n">STRUCT</span><span class="o">&lt;</span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"> </span><span class="k">ref</span><span class="p">:</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="k">role</span><span class="p">:</span><span class="w"> </span><span class="n">STRING</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">changeset</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">timestamp</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">uid</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">user</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">version</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">STORED</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ORCFILE</span><span class="w"></span>
<span class="k">LOCATION</span><span class="w"> </span><span class="s1">&#39;s3://osm-pds/planet/&#39;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Query 2:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">EXTERNAL</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">planet_history</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="k">MAP</span><span class="o">&lt;</span><span class="n">STRING</span><span class="p">,</span><span class="n">STRING</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">lat</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">lon</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">nds</span><span class="w"> </span><span class="nb">ARRAY</span><span class="o">&lt;</span><span class="n">STRUCT</span><span class="o">&lt;</span><span class="k">ref</span><span class="p">:</span><span class="w"> </span><span class="nb">BIGINT</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">members</span><span class="w"> </span><span class="nb">ARRAY</span><span class="o">&lt;</span><span class="n">STRUCT</span><span class="o">&lt;</span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"> </span><span class="k">ref</span><span class="p">:</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"> </span><span class="k">role</span><span class="p">:</span><span class="w"> </span><span class="n">STRING</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">changeset</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">timestamp</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">uid</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">user</span><span class="w"> </span><span class="n">STRING</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">version</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">visible</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">STORED</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ORCFILE</span><span class="w"></span>
<span class="k">LOCATION</span><span class="w"> </span><span class="s1">&#39;s3://osm-pds/planet-history/&#39;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Query 3:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">EXTERNAL</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">changesets</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="k">MAP</span><span class="o">&lt;</span><span class="n">STRING</span><span class="p">,</span><span class="n">STRING</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">open</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">closed_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">comments_count</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">min_lat</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">max_lat</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">min_lon</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">max_lon</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">num_changes</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">uid</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">user</span><span class="w"> </span><span class="n">STRING</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">STORED</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ORCFILE</span><span class="w"></span>
<span class="k">LOCATION</span><span class="w"> </span><span class="s1">&#39;s3://osm-pds/changesets/&#39;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<h4 id="load-vpc-flow-logs-data">Load VPC flow logs data<a class="headerlink" href="#load-vpc-flow-logs-data" title="Permanent link">&para;</a></h4>
<p>The second use case is a security-motivated one: analyzing network traffic
using <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html">VPC Flow Logs</a>.</p>
<p>First, we need to tell EC2 to generate VPC Flow Logs for us. So, if you have 
not done this already, you go ahead now and <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-s3.html#flow-logs-s3-create-flow-log">create VPC flow logs</a> 
either on the network interfaces level, subnet level, or VPC level.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To improve query performance and minimize the storage footprint, we store
the VPC flow logs in <a href="https://github.com/apache/parquet-format">Parquet</a>, a columnar storage format
that supports nested data.</p>
</div>
<p>For our setup it doesn't matter what option you choose (network interfaces, 
subnet, or VPC), as long as you publish them to an S3 bucket in Parquet format
as shown below:</p>
<p><img alt="Screen shot of the EC2 console &quot;Create flow log&quot; panel" src="../../images/ec2-vpc-flowlogs-creation.png" /></p>
<p>Now, again via the <a href="https://console.aws.amazon.com/athena/">Athena console</a>, create the table for the
VPC flow logs data in the same database you imported the OSM data, or create a new one,
if you prefer to do so.</p>
<p>Use the following SQL query and make sure that you're replacing
<code>VPC_FLOW_LOGS_LOCATION_IN_S3</code> with your own bucket/folder:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">EXTERNAL</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">vpclogs</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="o">`</span><span class="k">version</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">account_id</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">interface_id</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">srcaddr</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">dstaddr</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">srcport</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">dstport</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">protocol</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">packets</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">bytes</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="k">start</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="k">end</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">action</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">log_status</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">vpc_id</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">subnet_id</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">instance_id</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">tcp_flags</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">pkt_srcaddr</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">pkt_dstaddr</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">region</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">az_id</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">sublocation_type</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">sublocation_id</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">pkt_src_aws_service</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">pkt_dst_aws_service</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">flow_direction</span><span class="o">`</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="o">`</span><span class="n">traffic_path</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="n">STORED</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">PARQUET</span><span class="w"></span>
<span class="k">LOCATION</span><span class="w"> </span><span class="s1">&#39;VPC_FLOW_LOGS_LOCATION_IN_S3&#39;</span><span class="w"></span>
</code></pre></div>
<p>For example, <code>VPC_FLOW_LOGS_LOCATION_IN_S3</code> could look something like the
following if you're using the S3 bucket <code>allmyflowlogs</code>:</p>
<div class="highlight"><pre><span></span><code>s3://allmyflowlogs/AWSLogs/12345678901/vpcflowlogs/eu-west-1/2021/
</code></pre></div>
<p>Now that the datasets are available in Athena, let's move on to Grafana.</p>
<h3 id="set-up-grafana">Set up Grafana<a class="headerlink" href="#set-up-grafana" title="Permanent link">&para;</a></h3>
<p>We need a Grafana instance, so go ahead and set up a new <a href="https://console.aws.amazon.com/grafana/home#/workspaces">Amazon Managed Grafana
workspace</a>, for example by using the <a href="https://aws.amazon.com/blogs/mt/amazon-managed-grafana-getting-started/">Getting Started</a> guide,
or use an existing one.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>To use AWS data source configuration, first go to the Amazon Managed Grafana
console to enable service-mananged IAM roles that grant the workspace the 
IAM policies necessary to read the Athena resources.
Further, note the following:</p>
<ol>
<li>The Athena workgroup you plan to use needs to be tagged with the key 
<code>GrafanaDataSource</code> and value <code>true</code> for the service managed permissions
to be permitted to use the workgroup.</li>
<li>The service-managed IAM policy only grants access to query result buckets 
that start with <code>grafana-athena-query-results-</code>, so for any other bucket
you MUST add permissions manually.</li>
<li>You have to add the <code>s3:Get*</code> and <code>s3:List*</code> permissions for the underlying data source 
being queried manually.</li>
</ol>
</div>
<p>To set up the Athena data source, use the left-hand toolbar and choose the 
lower AWS icon and then choose "Athena". Select your default region you want 
the plugin to discover the Athena data source to use, and then select the 
accounts that you want, and finally choose "Add data source".</p>
<p>Alternatively, you can manually add and configure the Athena data source by 
following these steps:</p>
<ol>
<li>Click on the "Configurations" icon on the left-hand toolbar and then on "Add data source".</li>
<li>Search for "Athena".</li>
<li>[OPTIONAL] Configure the authentication provider (recommended: workspace IAM
   role).</li>
<li>Select your targeted Athena data source, database, and workgroup.</li>
<li>If your workgroup doesn't have an output location configured already,
   specify the S3 bucket and folder to use for query results. Note that the
   bucket has to start with <code>grafana-athena-query-results-</code> if you want to
   benefit from the service-managed policy.</li>
<li>Click "Save &amp; test".</li>
</ol>
<p>You should see something like the following:</p>
<p><img alt="Screen shot of the Athena data source config" src="../../images/amg-plugin-athena-ds.png" /></p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<p>And now let's look at how to use our Athena datasets from Grafana.</p>
<h3 id="use-geographical-data">Use geographical data<a class="headerlink" href="#use-geographical-data" title="Permanent link">&para;</a></h3>
<p>The <a href="https://aws.amazon.com/blogs/big-data/querying-openstreetmap-with-amazon-athena/">OpenStreetMap</a> (OSM) data in Athena can answer a number of questions,
such as "where are certain amenities". Let's see that in action.</p>
<p>For example, a SQL query against the OSM dataset to list places that offer food
in the Las Vegas region is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="n">tags</span><span class="p">[</span><span class="s1">&#39;amenity&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">amenity</span><span class="p">,</span><span class="w"></span>
<span class="n">tags</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="n">tags</span><span class="p">[</span><span class="s1">&#39;website&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">website</span><span class="p">,</span><span class="w"></span>
<span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">planet</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;node&#39;</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;amenity&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pub&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fast_food&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;restaurant&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">-</span><span class="mi">115</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">-</span><span class="mi">114</span><span class="p">.</span><span class="mi">5</span><span class="w"></span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">36</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">36</span><span class="p">.</span><span class="mi">3</span><span class="w"></span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The Las Vegas region in above query is defined as everything with a latitude 
between <code>36.1</code> and <code>36.3</code> as well as a longitude between <code>-115.5</code> and <code>-114.5</code>.
You could turn that into a set of variables (one for each corner) and make
the Geomap plugin adaptable to other regions.</p>
</div>
<p>To visualize the OSM data using above query, you can import an example dashboard, 
available via <a href="osm-sample-dashboard.json">osm-sample-dashboard.json</a>
that looks as follows:</p>
<p><img alt="Screen shot of the OSM dashboard in AMG" src="../../images/amg-osm-dashboard.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In above screen shot we use the Geomap visualization (in the left panel) to
plot the data points.</p>
</div>
<h3 id="use-vpc-flow-logs-data">Use VPC flow logs data<a class="headerlink" href="#use-vpc-flow-logs-data" title="Permanent link">&para;</a></h3>
<p>To analyze the VPC flow log data, detecting SSH and RDP traffic, use the
following SQL queries.</p>
<p>Getting a tabular overview on SSH/RDP traffic:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="n">srcaddr</span><span class="p">,</span><span class="w"> </span><span class="n">dstaddr</span><span class="p">,</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">log_status</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">vpclogs</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"></span>
<span class="n">srcport</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">3389</span><span class="p">)</span><span class="w"></span>
<span class="k">OR</span><span class="w"></span>
<span class="n">dstport</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">3389</span><span class="p">)</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>Getting a time series view on bytes accepted and rejected:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="n">from_unixtime</span><span class="p">(</span><span class="k">start</span><span class="p">),</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bytes</span><span class="p">),</span><span class="w"> </span><span class="n">action</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">vpclogs</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"></span>
<span class="n">srcport</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mi">3389</span><span class="p">)</span><span class="w"></span>
<span class="k">OR</span><span class="w"></span>
<span class="n">dstport</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">3389</span><span class="p">)</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">start</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want to limit the amount of data queried in Athena, consider using
the <code>$__timeFilter</code> macro.</p>
</div>
<p>To visualize the VPC flow log data, you can import an example dashboard, 
available via <a href="vpcfl-sample-dashboard.json">vpcfl-sample-dashboard.json</a>
that looks as follows:</p>
<p><img alt="Screen shot of the VPC flow logs dashboard in AMG" src="../../images/amg-vpcfl-dashboard.png" /></p>
<p>From here, you can use the following guides to create your own dashboard in
Amazon Managed Grafana:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/grafana/latest/userguide/dashboard-overview.html">User Guide: Dashboards</a></li>
<li><a href="https://grafana.com/docs/grafana/latest/best-practices/best-practices-for-creating-dashboards/">Best practices for creating dashboards</a></li>
</ul>
<p>That's it, congratulations you've learned how to use Athena from Grafana!</p>
<h2 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">&para;</a></h2>
<p>Remove the OSM data from the Athena database you've been using and then
the Amazon Managed Grafana workspace by removing it from the console.</p>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Amazon 2021 
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>