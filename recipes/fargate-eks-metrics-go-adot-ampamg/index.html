
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="AWS">
      
      
        <link rel="canonical" href="https://aws-observability.github.io/aws-o11y-recipes/recipes/fargate-eks-metrics-go-adot-ampamg/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.1">
    
    
      
        <title>Using AWS Distro for OpenTelemetry in EKS on Fargate with Amazon Managed Service for Prometheus - AWS Observability Recipes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ffa724">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i%7CPT+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Lato";--md-code-font:"PT Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    

<script>
  (function(n,i,v,r,s,c,x,z){x=window.AwsRumClient={q:[],n:n,i:i,v:v,r:r,c:c};window[n]=function(c,p){x.q.push({c:c,p:p});};z=document.createElement('script');z.async=true;z.src=s;document.head.insertBefore(z,document.head.getElementsByTagName('script')[0]);})(
    'cwr',
    'eb23e08d-e6d5-491d-8533-7ed9d0bc67d6',
    '1.0.0',
    'us-east-1',
    'https://client.rum.us-east-1.amazonaws.com/1.12.0/cwr.js',
    {
      sessionSampleRate: 1,
      guestRoleArn: "arn:aws:iam::913180151358:role/RUM-Monitor-us-east-1-913180151358-9729762338561-Unauth",
      identityPoolId: "us-east-1:f1fb552f-ddbe-4476-883f-d53be9a9c14c",
      endpoint: "https://dataplane.rum.us-east-1.amazonaws.com",
      telemetries: ["performance","errors","http"],
      allowCookies: false,
      enableXRay: false
    }
  );
</script>


  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-aws-distro-for-opentelemetry-in-eks-on-fargate-with-amazon-managed-service-for-prometheus" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AWS Observability Recipes" class="md-header__button md-logo" aria-label="AWS Observability Recipes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M256 0v128h128L256 0zm32 256H96v64h192v-64zm-64-128V0H48C21.49 0 0 21.49 0 48v416c0 26.5 21.49 48 48 48h288c26.51 0 48-21.49 48-48V160H256.9c-18.6 0-32.9-14.3-32.9-32zM64 72c0-4.37 3.63-8 8-8h80c4.4 0 8 3.63 8 8v16c0 4.38-3.6 8-8 8H72c-4.37 0-8-3.62-8-8V72zm0 64c0-4.4 3.63-8 8-8h80c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H72c-4.37 0-8-3.6-8-8v-16zm256 304c0 4.375-3.625 8-8 8h-80c-4.4 0-8-3.6-8-8v-16c0-4.375 3.625-8 8-8h80c4.375 0 8 3.625 8 8v16zm0-200v96c0 8.875-7.125 16-16 16H80c-8.87 0-16-7.1-16-16v-96c0-8.9 7.13-16 16-16h224c8.9 0 16 7.1 16 16z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AWS Observability Recipes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Using AWS Distro for OpenTelemetry in EKS on Fargate with Amazon Managed Service for Prometheus
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-observability/aws-o11y-recipes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-observability/aws-o11y-recipes
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../apprunner/" class="md-tabs__link">
        By Compute
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../infra/" class="md-tabs__link">
        By Infra & Databases
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../java/" class="md-tabs__link">
        By Language
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../cw/" class="md-tabs__link">
        By Destination
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../anomaly-detection/" class="md-tabs__link">
        Tasks
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../about/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AWS Observability Recipes" class="md-nav__button md-logo" aria-label="AWS Observability Recipes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M256 0v128h128L256 0zm32 256H96v64h192v-64zm-64-128V0H48C21.49 0 0 21.49 0 48v416c0 26.5 21.49 48 48 48h288c26.51 0 48-21.49 48-48V160H256.9c-18.6 0-32.9-14.3-32.9-32zM64 72c0-4.37 3.63-8 8-8h80c4.4 0 8 3.63 8 8v16c0 4.38-3.6 8-8 8H72c-4.37 0-8-3.62-8-8V72zm0 64c0-4.4 3.63-8 8-8h80c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H72c-4.37 0-8-3.6-8-8v-16zm256 304c0 4.375-3.625 8-8 8h-80c-4.4 0-8-3.6-8-8v-16c0-4.375 3.625-8 8-8h80c4.375 0 8 3.625 8 8v16zm0-200v96c0 8.875-7.125 16-16 16H80c-8.87 0-16-7.1-16-16v-96c0-8.9 7.13-16 16-16h224c8.9 0 16 7.1 16 16z"/></svg>

    </a>
    AWS Observability Recipes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-observability/aws-o11y-recipes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-observability/aws-o11y-recipes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome!
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dimensions/" class="md-nav__link">
        Dimensions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../telemetry/" class="md-nav__link">
        Telemetry
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          By Compute
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Compute" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          By Compute
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../apprunner/" class="md-nav__link">
        AWS App Runner
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eks/" class="md-nav__link">
        Amazon Elastic Kubernetes Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ecs/" class="md-nav__link">
        Amazon Elastic Container Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lambda/" class="md-nav__link">
        AWS Lambda
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          By Infra & Databases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Infra & Databases" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          By Infra & Databases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../infra/" class="md-nav__link">
        Infra
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Databases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Databases" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Databases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rds/" class="md-nav__link">
        Amazon Relational Database Service
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dynamodb/" class="md-nav__link">
        Amazon DynamoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../msk/" class="md-nav__link">
        Amazon Managed Streaming for Apache Kafka
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          By Language
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Language" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          By Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../java/" class="md-nav__link">
        Java
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../nodejs/" class="md-nav__link">
        Node.js
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          By Destination
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="By Destination" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          By Destination
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cw/" class="md-nav__link">
        Amazon CloudWatch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../amp/" class="md-nav__link">
        Amazon Managed Service for Prometheus
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../amg/" class="md-nav__link">
        Amazon Managed Grafana
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aes/" class="md-nav__link">
        Amazon OpenSearch Service
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Tasks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tasks" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Tasks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../anomaly-detection/" class="md-nav__link">
        Anomaly Detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../alerting/" class="md-nav__link">
        Alerting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../workshops/" class="md-nav__link">
        Workshops
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#infrastructure" class="md-nav__link">
    Infrastructure
  </a>
  
    <nav class="md-nav" aria-label="Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-eks-on-fargate-cluster" class="md-nav__link">
    Create EKS on Fargate cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-ecr-repository" class="md-nav__link">
    Create ECR repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-amp" class="md-nav__link">
    Set up AMP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-adot-collector" class="md-nav__link">
    Set up ADOT Collector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-amg" class="md-nav__link">
    Set up AMG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application" class="md-nav__link">
    Application
  </a>
  
    <nav class="md-nav" aria-label="Application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-container-image" class="md-nav__link">
    Build container image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-sample-app" class="md-nav__link">
    Deploy sample app
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end" class="md-nav__link">
    End-to-end
  </a>
  
    <nav class="md-nav" aria-label="End-to-end">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verify-your-pipeline-is-working" class="md-nav__link">
    Verify your pipeline is working
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-grafana-dashboard" class="md-nav__link">
    Create a Grafana dashboard
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/aws-observability/aws-o11y-recipes/edit/master/docs/recipes/fargate-eks-metrics-go-adot-ampamg.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="using-aws-distro-for-opentelemetry-in-eks-on-fargate-with-amazon-managed-service-for-prometheus">Using AWS Distro for OpenTelemetry in EKS on Fargate with Amazon Managed Service for Prometheus<a class="headerlink" href="#using-aws-distro-for-opentelemetry-in-eks-on-fargate-with-amazon-managed-service-for-prometheus" title="Permanent link">&para;</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This site is being merged into the broader <a href="https://aws-observability.github.io/observability-best-practices/recipes/">Observability Best Practices</a> content. Please head over there for the latest updates, plus prescriptive guidance on the use of AWS observability tools.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This site will be kept as-is until January 2023, when it will be decommissioned.</p>
</div>
<hr />
<p>In this recipe we show you how to instrument a <a href="https://github.com/aws-observability/aws-otel-community/tree/master/sample-apps/prometheus">sample Go application</a> and
use <a href="https://aws.amazon.com/otel">AWS Distro for OpenTelemetry (ADOT)</a> to ingest metrics into
<a href="https://aws.amazon.com/prometheus/">Amazon Managed Service for Prometheus</a> .
Then we're using <a href="https://aws.amazon.com/grafana/">Amazon Managed Grafana</a> to visualize the metrics.</p>
<p>We will be setting up an <a href="https://aws.amazon.com/eks/">Amazon Elastic Kubernetes Service (EKS)</a>
on <a href="https://aws.amazon.com/fargate/">AWS Fargate</a> cluster and use an
<a href="https://aws.amazon.com/ecr/">Amazon Elastic Container Registry (ECR)</a> repository
to demonstrate a complete scenario.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide will take approximately 1 hour to complete.</p>
</div>
<h2 id="infrastructure">Infrastructure<a class="headerlink" href="#infrastructure" title="Permanent link">&para;</a></h2>
<p>In the following section we will be setting up the infrastructure for this recipe. </p>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<p>The ADOT pipeline enables us to use the 
<a href="https://github.com/aws-observability/aws-otel-collector">ADOT Collector</a> to 
scrape a Prometheus-instrumented application, and ingest the scraped metrics to
Amazon Managed Service for Prometheus. </p>
<p><img alt="Architecture" src="../../images/adot-metrics-pipeline.png" /></p>
<p>The ADOT Collector includes two components specific to Prometheus: </p>
<ul>
<li>the Prometheus Receiver, and </li>
<li>the AWS Prometheus Remote Write Exporter.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more information on Prometheus Remote Write Exporter check out:
<a href="https://aws-otel.github.io/docs/getting-started/prometheus-remote-write-exporter">Getting Started with Prometheus Remote Write Exporter for AMP</a>.</p>
</div>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h3>
<ul>
<li>The AWS CLI is <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">installed</a> and <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">configured</a> in your environment.</li>
<li>You need to install the <a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html">eksctl</a> command in your environment.</li>
<li>You need to install <a href="https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html">kubectl</a> in your environment. </li>
<li>You have <a href="https://docs.docker.com/get-docker/">Docker</a> installed into your environment.</li>
</ul>
<h3 id="create-eks-on-fargate-cluster">Create EKS on Fargate cluster<a class="headerlink" href="#create-eks-on-fargate-cluster" title="Permanent link">&para;</a></h3>
<p>Our demo application is a Kubernetes app that we will run in an EKS on Fargate
cluster. So, first create an EKS cluster using the
provided <a href="cluster-config.yaml">cluster-config.yaml</a>
template file by changing <code>&lt;YOUR_REGION&gt;</code> to one of the
<a href="https://docs.aws.amazon.com/prometheus/latest/userguide/what-is-Amazon-Managed-Service-Prometheus.html#AMP-supported-Regions">supported regions for AMP</a>.</p>
<p>Make sure to set <code>&lt;YOUR_REGION&gt;</code> in your shell session, for example, in Bash:</p>
<div class="highlight"><pre><span></span><code>export AWS_DEFAULT_REGION=&lt;YOUR_REGION&gt;
</code></pre></div>
<p>Create your cluster using the following command:</p>
<div class="highlight"><pre><span></span><code>eksctl create cluster -f cluster-config.yaml
</code></pre></div>
<h3 id="create-ecr-repository">Create ECR repository<a class="headerlink" href="#create-ecr-repository" title="Permanent link">&para;</a></h3>
<p>In order to deploy our application to EKS we need a container repository. 
You can use the following command to create a new ECR repository in your account.
Make sure to set <code>&lt;YOUR_REGION&gt;</code> as well.</p>
<div class="highlight"><pre><span></span><code>aws ecr create-repository \
    --repository-name prometheus-sample-app \
    --image-scanning-configuration scanOnPush=true \
    --region &lt;YOUR_REGION&gt;
</code></pre></div>
<h3 id="set-up-amp">Set up AMP<a class="headerlink" href="#set-up-amp" title="Permanent link">&para;</a></h3>
<p>First, create an Amazon Managed Service for Prometheus workspace using the AWS CLI with:</p>
<div class="highlight"><pre><span></span><code>aws amp create-workspace --alias prometheus-sample-app
</code></pre></div>
<p>Verify the workspace is created using:</p>
<div class="highlight"><pre><span></span><code>aws amp list-workspaces
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more details check out the <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-getting-started.html">AMP Getting started</a> guide.</p>
</div>
<h3 id="set-up-adot-collector">Set up ADOT Collector<a class="headerlink" href="#set-up-adot-collector" title="Permanent link">&para;</a></h3>
<p>Download <a href="adot-collector-fargate.yaml">adot-collector-fargate.yaml</a> 
and edit this YAML doc with the parameters described in the next steps.</p>
<p>In this example, the ADOT Collector configuration uses an annotation <code>(scrape=true)</code> 
to tell which target endpoints to scrape. This allows the ADOT Collector to distinguish 
the sample app endpoint from <code>kube-system</code> endpoints in your cluster.
You can remove this from the re-label configurations if you want to scrape a different sample app. </p>
<p>Use the following steps to edit the downloaded file for your environment:</p>
<p>1. Replace <code>&lt;YOUR_REGION&gt;</code> with your current region. </p>
<p>2. Replace <code>&lt;YOUR_ENDPOINT&gt;</code> with the remote write URL of your workspace.</p>
<p>Get your AMP remote write URL endpoint by executing the following queries. </p>
<p>First, get the workspace ID like so:</p>
<div class="highlight"><pre><span></span><code>YOUR_WORKSPACE_ID=$(aws amp list-workspaces \
                    --alias prometheus-sample-app \
                    --query &#39;workspaces[0].workspaceId&#39; --output text)
</code></pre></div>
<p>Now get the remote write URL endpoint URL for your workspace using:</p>
<div class="highlight"><pre><span></span><code>YOUR_ENDPOINT=$(aws amp describe-workspace \
                --workspace-id $YOUR_WORKSPACE_ID  \
                --query &#39;workspace.prometheusEndpoint&#39; --output text)api/v1/remote_write
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure that <code>YOUR_ENDPOINT</code> is in fact the remote write URL, that is, 
the URL should end in <code>/api/v1/remote_write</code>.</p>
</div>
<p>After creating deployment file we can now apply this to our cluster by using the following command: </p>
<div class="highlight"><pre><span></span><code>kubectl apply -f adot-collector-fargate.yaml
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For more information check out the <a href="https://aws-otel.github.io/docs/getting-started/prometheus-remote-write-exporter/eks#aws-distro-for-opentelemetry-adot-collector-setup">AWS Distro for OpenTelemetry (ADOT) 
Collector Setup</a>.</p>
</div>
<h3 id="set-up-amg">Set up AMG<a class="headerlink" href="#set-up-amg" title="Permanent link">&para;</a></h3>
<p>Set up a new AMG workspace using the 
<a href="https://aws.amazon.com/blogs/mt/amazon-managed-grafana-getting-started/">Amazon Managed Grafana – Getting Started</a> guide.</p>
<p>Make sure to add "Amazon Managed Service for Prometheus" as a datasource during creation.</p>
<p><img alt="Service managed permission settings" src="../../images/amg-console-create-workspace-managed-permissions.jpg" /></p>
<h2 id="application">Application<a class="headerlink" href="#application" title="Permanent link">&para;</a></h2>
<p>In this recipe we will be using a
<a href="https://github.com/aws-observability/aws-otel-community/tree/master/sample-apps/prometheus">sample application</a> 
from the AWS Observability repository.</p>
<p>This Prometheus sample app generates all four Prometheus metric types 
(counter, gauge, histogram, summary) and exposes them at the <code>/metrics</code> endpoint.</p>
<h3 id="build-container-image">Build container image<a class="headerlink" href="#build-container-image" title="Permanent link">&para;</a></h3>
<p>To build the container image, first clone the Git repository and change
into the directory as follows:</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/aws-observability/aws-otel-community.git &amp;&amp; \
cd ./aws-otel-community/sample-apps/prometheus
</code></pre></div>
<p>First, set the region (if not already done above) and account ID to what is applicable in your case. 
Replace <code>&lt;YOUR_REGION&gt;</code> with your current region. For
example, in the Bash shell this would look as follows:</p>
<div class="highlight"><pre><span></span><code>export AWS_DEFAULT_REGION=&lt;YOUR_REGION&gt;
export ACCOUNTID=`aws sts get-caller-identity --query Account --output text`
</code></pre></div>
<p>Next, build the container image:</p>
<div class="highlight"><pre><span></span><code>docker build . -t &quot;$ACCOUNTID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/prometheus-sample-app:latest&quot;
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <code>go mod</code> fails in your environment due to a proxy.golang.or i/o timeout,
you are able to bypass the go mod proxy by editing the Dockerfile.</p>
<p>Change the following line in the Docker file:
<div class="highlight"><pre><span></span><code>RUN GO111MODULE=on go mod download
</code></pre></div>
to:
<div class="highlight"><pre><span></span><code>RUN GOPROXY=direct GO111MODULE=on go mod download
</code></pre></div></p>
</div>
<p>Now you can push the container image to the ECR repo you created earlier on.</p>
<p>For that, first log in to the default ECR registry:</p>
<div class="highlight"><pre><span></span><code>aws ecr get-login-password --region $AWS_DEFAULT_REGION | \
    docker login --username AWS --password-stdin \
    &quot;$ACCOUNTID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com&quot;
</code></pre></div>
<p>And finally, push the container image to the ECR repository you created, above:</p>
<div class="highlight"><pre><span></span><code>docker push &quot;$ACCOUNTID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/prometheus-sample-app:latest&quot;
</code></pre></div>
<h3 id="deploy-sample-app">Deploy sample app<a class="headerlink" href="#deploy-sample-app" title="Permanent link">&para;</a></h3>
<p>Edit <a href="prometheus-sample-app.yaml">prometheus-sample-app.yaml</a>
to contain your ECR image path. That is, replace <code>ACCOUNTID</code> and <code>AWS_DEFAULT_REGION</code> in the
file with your own values:</p>
<div class="highlight"><pre><span></span><code>    # change the following to your container image:
    image: &quot;ACCOUNTID.dkr.ecr.AWS_DEFAULT_REGION.amazonaws.com/prometheus-sample-app:latest&quot;
</code></pre></div>
<p>Now you can deploy the sample app to your cluster using:</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f prometheus-sample-app.yaml
</code></pre></div>
<h2 id="end-to-end">End-to-end<a class="headerlink" href="#end-to-end" title="Permanent link">&para;</a></h2>
<p>Now that you have the infrastructure and the application in place, we will
test out the setup, sending metrics from the Go app running in EKS to AMP and
visualize it in AMG.</p>
<h3 id="verify-your-pipeline-is-working">Verify your pipeline is working<a class="headerlink" href="#verify-your-pipeline-is-working" title="Permanent link">&para;</a></h3>
<p>To verify if the ADOT collector is scraping the pod of the sample app and
ingests the metrics into AMP, we look at the collector logs.</p>
<p>Enter the following command to follow the ADOT collector logs:</p>
<div class="highlight"><pre><span></span><code>kubectl -n adot-col logs adot-collector -f
</code></pre></div>
<p>One example output in the logs of the scraped metrics from the sample app 
should look like the following:</p>
<div class="highlight"><pre><span></span><code>...
Resource labels:
     -&gt; service.name: STRING(kubernetes-service-endpoints)
     -&gt; host.name: STRING(192.168.16.238)
     -&gt; port: STRING(8080)
     -&gt; scheme: STRING(http)
InstrumentationLibraryMetrics #0
Metric #0
Descriptor:
     -&gt; Name: test_gauge0
     -&gt; Description: This is my gauge
     -&gt; Unit: 
     -&gt; DataType: DoubleGauge
DoubleDataPoints #0
StartTime: 0
Timestamp: 1606511460471000000
Value: 0.000000
...
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To verify if AMP received the metrics, you can use <a href="https://github.com/okigan/awscurl">awscurl</a>.
This tool enables you to send HTTP requests from the command line with AWS Sigv4 authentication,
so you must have AWS credentials set up locally with the correct permissions to query from AMP.
In the following command replace <code>$AMP_ENDPOINT</code> with the endpoint for your AMP workspace:</p>
<div class="highlight"><pre><span></span><code>$ awscurl --service=&quot;aps&quot; \ 
        --region=&quot;$AWS_DEFAULT_REGION&quot; &quot;https://$AMP_ENDPOINT/api/v1/query?query=adot_test_gauge0&quot;
{&quot;status&quot;:&quot;success&quot;,&quot;data&quot;:{&quot;resultType&quot;:&quot;vector&quot;,&quot;result&quot;:[{&quot;metric&quot;:{&quot;__name__&quot;:&quot;adot_test_gauge0&quot;},&quot;value&quot;:[1606512592.493,&quot;16.87214000011479&quot;]}]}}
</code></pre></div>
</div>
<h3 id="create-a-grafana-dashboard">Create a Grafana dashboard<a class="headerlink" href="#create-a-grafana-dashboard" title="Permanent link">&para;</a></h3>
<p>You can import an example dashboard, available via
<a href="prometheus-sample-app-dashboard.json">prometheus-sample-app-dashboard.json</a>,
for the sample app that looks as follows:</p>
<p><img alt="Screen shot of the Prometheus sample app dashboard in AMG" src="../../images/amg-prom-sample-app-dashboard.png" /></p>
<p>Further, use the following guides to create your own dashboard in Amazon Managed Grafana:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/grafana/latest/userguide/dashboard-overview.html">User Guide: Dashboards</a></li>
<li><a href="https://grafana.com/docs/grafana/latest/best-practices/best-practices-for-creating-dashboards/">Best practices for creating dashboards</a></li>
</ul>
<p>That's it, congratulations you've learned how to use ADOT in EKS on Fargate to 
ingest metrics.</p>
<h2 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">&para;</a></h2>
<p>First remove the Kubernetes resources and destroy the EKS cluster:</p>
<div class="highlight"><pre><span></span><code>kubectl delete all --all &amp;&amp; \
eksctl delete cluster --name amp-eks-fargate
</code></pre></div>
<p>Remove the Amazon Managed Service for Prometheus workspace:</p>
<div class="highlight"><pre><span></span><code>aws amp delete-workspace --workspace-id \
    `aws amp list-workspaces --alias prometheus-sample-app --query &#39;workspaces[0].workspaceId&#39; --output text`
</code></pre></div>
<p>Remove the  IAM role:</p>
<div class="highlight"><pre><span></span><code>aws delete-role --role-name adot-collector-role
</code></pre></div>
<p>Finally, remove the Amazon Managed Grafana  workspace by removing it via the AWS console. </p>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Amazon 2021 
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>